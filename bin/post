#!/bin/bash

# Author: anzu
# Description: A simple blogging system made in bash. This is the main script that does most of the work.
# Version: 1.0.0

# CONFIG #
# Change this to whatever path fits your usage. Don't put the trailing slash here.
path="/srv/http/sbb"

# SCRIPT

markdown -v >/dev/null 2>&1 || { echo >&2 "This script requires that markdown be installed."; exit 1; }

createIndexFile() {
	echo "<html>"
}

if ! [ -d $path/posts/ ]; then
	mkdir -p $path/posts
fi

if [ -z $EDITOR ]; then
	EDITOR=nano
fi

postdate=$(date "+%Y-%m")
index=$(ls $path/posts | wc)

createTitle() {
	echo -n "Enter post-title: "
	read -r title
	if [ -z "$title" ]; then
		echo "Title can't be empty. Aborting."
		exit 1
	fi
}

createBlogIndex() {
	count=$(ls $path/posts/ | wc -l)
	index=$(printf "0x%04x\n" $count)
}

createFileName() {
	filename=$(echo -n "$title" | tr -d '!"@£$#¤%&/()=?.,^*<>-' | tr "[:upper:] " "[:lower:]-")
}

# This function creates the <head> part of the post html.
createHeader() {
	echo "<html>"
	echo "<head>"
	echo "<title>$title</title>"
	echo "<link rel='stylesheet' type='text/css' href='../style.css'/>"
	echo "</head>"
	echo "<body>"
} > $path/$filename

# This function creates the footer of the post html.
createFooter() {
	echo "</body>"
	echo "</html>"
} >> $path/$filename

# This function calls $EDITOR to write a blog post.
createPost() {
	$EDITOR $path/tmpfile
	if [ -s $path/tmpfile ]; then
		markdown $path/tmpfile
	else
		echo "Post content empty!"
		exit 1
	fi
} >> $path/$filename

updatePostList() {
	link=$(echo "[$index - $title](posts/${filename}.html)" | markdown)
	sed -i "8a ${link}" $path/index.html
}

cleanup() {
	mv $path/$filename $path/posts/${filename}.html
	rm $path/tmpfile
}

createTitle || exit
createBlogIndex
createFileName

createHeader
createPost || exit
createFooter

updatePostList

cleanup
